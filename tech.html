<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Helm — Tech Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    tr:hover { background: #f9fafb; }
    .btn { @apply rounded-xl bg-black text-white px-3 py-2 text-sm font-semibold hover:opacity-90; }
    .btn-outline { @apply rounded-xl border border-gray-300 px-3 py-2 text-sm font-semibold hover:bg-gray-50; }
    .link { @apply text-blue-600 hover:underline; }
    .kbd { @apply inline-block rounded-md border border-gray-300 px-1.5 py-0.5 text-xs bg-gray-50; }
    /* Shaded inputs & selects */
    .input {
      @apply w-full rounded-xl border border-gray-300 p-2.5 bg-gray-50
             focus:outline-none focus:ring-2 focus:ring-black focus:border-black transition;
    }
    .select {
      @apply w-full rounded-xl border border-gray-300 p-2.5 bg-gray-50
             focus:outline-none focus:ring-2 focus:ring-black focus:border-black transition;
      appearance: none;
    }
    .pill { @apply inline-flex items-center justify-center rounded-lg border border-gray-300 px-2 py-1 text-sm bg-white; }
    .badge { @apply inline-flex items-center rounded-md px-2 py-0.5 text-[11px] font-medium; }
    .badge-green { @apply bg-green-50 text-green-700 border border-green-200; }
    .badge-amber { @apply bg-amber-50 text-amber-700 border border-amber-200; }
    .badge-gray  { @apply bg-gray-50 text-gray-600 border border-gray-200; }
    .tiny { @apply text-[11px] text-gray-500; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <main class="mx-auto max-w-7xl p-6 pt-10">
    <div class="bg-white shadow-xl rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">Customers Needing Liability (All Time, Open Only)</h1>
        <div class="flex items-center gap-3">
          <button id="refreshBtn" class="btn">Refresh</button>
        </div>
      </div>
      <p class="text-sm text-gray-600 mb-4">
        Each row is a <strong>participant</strong> (adult or minor) from an Intake that does <em>not</em> have a matching Liability yet. Match is by Smartwaiver tag <code>ls_&lt;lightspeed_id&gt;</code> (preferred) or by email/name when tag is missing.
      </p>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-600 border-b">
              <th class="py-2 pr-4">Signed</th>
              <th class="py-2 pr-4">Participant</th>
              <th class="py-2 pr-4">Email</th>
              <th class="py-2 pr-4">Age</th>
              <th class="py-2 pr-4">Wt (lb)</th>
              <th class="py-2 pr-4">Ht (cm)</th>
              <th class="py-2 pr-4">Skier</th>
              <th class="py-2 pr-4">LS ID</th>
              <th class="py-2 pr-4">Intake PDF</th>
              <th class="py-2 pr-4">Status</th>
              <th class="py-2 pr-4">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="foot" class="text-xs text-gray-500 mt-3"></div>
      <div class="text-xs text-gray-400 mt-1">build: tech-din-preliab-v7.0-participants-alltime</div>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden rounded-xl bg-black text-white px-4 py-2 text-sm shadow-lg"></div>

  <!-- DIN modal -->
  <div id="dinModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-[920px] max-w-[95vw]">
      <div class="flex items-start justify-between mb-3">
        <h3 class="text-lg font-semibold">DIN Calculator (pre-Liability)</h3>
        <button id="dinClose" class="btn-outline">Close</button>
      </div>

      <div id="dinBody" class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <!-- Left: Intake snapshot -->
        <div class="border rounded-2xl p-4">
          <h4 class="font-semibold mb-2">Participant Measurements</h4>
          <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
            <dt class="text-gray-500">Participant</dt><dd id="i_name" class="font-medium">—</dd>
            <dt class="text-gray-500">Email</dt><dd id="i_email" class="font-medium">—</dd>
            <dt class="text-gray-500">Age</dt><dd id="i_age" class="font-medium">—</dd>
            <dt class="text-gray-500">Weight</dt><dd id="i_weight" class="font-medium">—</dd>
            <dt class="text-gray-500">Height</dt><dd id="i_height" class="font-medium">—</dd>
            <dt class="text-gray-500">Skier Type</dt><dd id="i_skier" class="font-medium">—</dd>
          </dl>
          <p class="tiny mt-3">Height shown in centimeters. Source: Intake answers for selected participant.</p>
        </div>

        <!-- Right: Inputs & Result -->
        <div class="border rounded-2xl p-4 bg-gray-50">
          <h4 class="font-semibold mb-2">Tech Inputs</h4>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs text-gray-700 mb-1">Boot Sole Length (mm)</label>
              <input id="inp_bsl" type="number" min="200" max="420" step="1" class="input" placeholder="e.g. 315">
              <p id="bsl_hint" class="tiny mt-1"></p>
            </div>
            <div>
              <label class="block text-xs text-gray-700 mb-1">Skier Type</label>
              <select id="inp_type" class="select">
                <option value="I">Type I (conservative)</option>
                <option value="II" selected>Type II (average)</option>
                <option value="III">Type III (aggressive)</option>
              </select>
              <p class="tiny mt-1">Prefilled from Intake when available.</p>
            </div>
            <div>
              <label class="block text-xs text-gray-700 mb-1">Age Adjustment</label>
              <select id="inp_ageAdj" class="select">
                <option value="auto" selected>Auto (use age ≤9 or ≥50 → −1)</option>
                <option value="none">No adjustment</option>
                <option value="minus1">Reduce one level</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-700 mb-1">Basis (Weight vs Height)</label>
              <select id="inp_basis" class="select">
                <option value="weight" selected>Weight (recommended)</option>
                <option value="height">Height</option>
                <option value="auto">Auto (more conservative)</option>
              </select>
            </div>
          </div>

          <!-- Base DIN -->
          <div class="mt-4 border rounded-lg p-3 bg-white">
            <div class="text-sm text-gray-600">Base Result</div>
            <div class="mt-1 flex items-baseline gap-3">
              <div class="text-2xl font-bold" id="out_din">—</div>
              <div class="text-sm text-gray-500">Release value (chart)</div>
            </div>
            <div class="mt-1 text-xs text-gray-600" id="out_summary"></div>

            <!-- Per-foot outputs (mirror base result; no nudges) -->
            <div class="mt-4 grid grid-cols-2 gap-3">
              <div class="border rounded-lg p-3 bg-gray-50">
                <div class="text-sm font-semibold mb-2">Left Binding</div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-gray-600">Toe</span>
                  <span id="out_left_toe" class="pill w-20 text-center">—</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-xs text-gray-600">Heel</span>
                  <span id="out_left_heel" class="pill w-20 text-center">—</span>
                </div>
              </div>
              <div class="border rounded-lg p-3 bg-gray-50">
                <div class="text-sm font-semibold mb-2">Right Binding</div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-gray-600">Toe</span>
                  <span id="out_right_toe" class="pill w-20 text-center">—</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-xs text-gray-600">Heel</span>
                  <span id="out_right_heel" class="pill w-20 text-center">—</span>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4 flex items-center gap-3">
            <button id="btnCopy" class="btn-outline">
              Copy All <span class="kbd">⌘C</span>
            </button>
            <button id="btnOpenLiab" class="btn">Open Liability</button>
          </div>

          <p class="tiny mt-3 leading-relaxed">
            <strong>Note:</strong> Base DIN mirrors to all four positions. Always verify against current ISO 11088/manufacturer charts and shop procedures.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= Config & constants =========
    let LIABILITY_WAIVER_ID = "";
    const REFRESH_MS   = 10000;           // poll (fallback)
    const SSE_GRACE_MS = 3 * 60 * 1000;   // keep SSE-only rows for 3 minutes
    const CLEANUP_MS   = 60 * 1000;

    // ========= Utils =========
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2500); }
    function fmtTime(s){ try{ return new Date(s).toLocaleString(); }catch{ return s||"—"; } }
    function toCmFromInches(totalIn){ const n=Number(totalIn); if(!Number.isFinite(n)) return ""; return Math.round(n*2.54); }

    // ========= API wrappers =========
    async function fetchIntakeDetails(waiverId){
      const r = await fetch(`/api/intake-details?waiverId=${encodeURIComponent(waiverId)}`);
      if(!r.ok) throw new Error(`intake-details ${r.status}`);
      return await r.json(); // expected to include participants[]
    }
    async function fetchLatestLiability({ tag, email }){
      const q=new URLSearchParams(); if(tag) q.set("tag",tag); if(email) q.set("email",email);
      const r=await fetch(`/api/liability-latest?${q.toString()}`);
      if(!r.ok) return {};
      return await r.json();
    }
    function buildLiabilityUrl({ email, lightspeed_id, first_name, last_name }){
      const p=new URLSearchParams();
      if(email)        p.set("wautofill_email",email);
      if(lightspeed_id)p.set("wautofill_tag",`ls_${lightspeed_id}`);
      if(first_name)   p.set("wautofill_firstname",first_name);
      if(last_name)    p.set("wautofill_lastname",last_name);
      return `https://www.smartwaiver.com/w/${LIABILITY_WAIVER_ID}/kiosk/?${p.toString()}`;
    }

    // ========= DIN lookups =========
    const CODE_BY_WEIGHT = [
      { max:  29, code: 0 }, { max:  38, code: 1 }, { max:  47, code: 2 }, { max:  56, code: 3 },
      { max:  66, code: 4 }, { max:  78, code: 5 }, { max:  91, code: 6 }, { max: 107, code: 7 },
      { max: 125, code: 8 }, { max: 147, code: 9 }, { max: 174, code:10 }, { max: 209, code:11 },
      { max: 999, code:12 },
    ];
    const CODE_BY_HEIGHT_CM = [
      { max: 148, code: 7 }, { max: 157, code: 8 }, { max: 166, code: 9 },
      { max: 178, code: 10 }, { max: 194, code: 11 }, { max: 999, code: 12 },
    ];
    const DIN_TABLE = [
      [0.75,0.75,0.75, null,  null,  null,  null,  null],
      [1.00,0.75,0.75,0.75,   null,  null,  null,  null],
      [1.50,1.25,1.25,1.00,   null,  null,  null,  null],
      [2.00,1.75,1.50,1.50, 1.25,   null,  null,  null],
      [2.50,2.25,2.00,1.75, 1.50, 1.50,   null,  null],
      [3.00,2.75,2.50,2.25, 2.00, 1.75, 1.75,   null],
      [ null,3.50,3.00,2.75, 2.50, 2.25, 2.00,   null],
      [ null, null,3.50,3.00, 3.00, 2.75, 2.50,  null],
      [ null, null,4.50,4.00, 3.50, 3.50, 3.00,  null],
      [ null, null,5.50,5.00, 4.50, 4.00, 3.50, 3.00],
      [ null, null,6.50,6.00, 5.50, 5.00, 4.50, 4.00],
      [ null, null,7.50,7.00, 6.50, 6.00, 5.50, 5.00],
      [ null, null, null,8.50, 8.00, 7.00, 6.50, 6.00],
      [ null, null, null,10.00,9.50, 8.50, 8.00, 7.50],
      [ null, null, null,11.50,11.00,10.00, 9.50, 9.00],
      [ null, null, null, null,  null, 12.00,11.00,10.50],
    ];

    function bslBandIndex(bsl) {
      const x = Number(bsl);
      if (!Number.isFinite(x)) return 0;
      if (x < 231) return 0;
      if (x <= 250) return 1;
      if (x <= 270) return 2;
      if (x <= 290) return 3;
      if (x <= 310) return 4;
      if (x <= 330) return 5;
      if (x <= 350) return 6;
      return 7;
    }
    function codeFromWeightLbs(w){ for (const r of CODE_BY_WEIGHT) if (w <= r.max) return r.code; return 0; }
    function codeFromHeightCm(cm){ for (const r of CODE_BY_HEIGHT_CM) if (cm <= r.max) return r.code; return 0; }

    const BSL_BANDS = ["<231","231–250","251–270","271–290","291–310","311–330","331–350",">350"];

    function computeDIN({ weight_lb, height_in, age_years, skierType, bsl_mm, basis = "auto", ageAdj = "auto" }) {
      const w = Number(weight_lb);
      if (!Number.isFinite(w)) return { din:null, code:"", band:"", explain:"Missing weight" };

      const totalIn = Number(height_in);
      const ft = Number.isFinite(totalIn) ? Math.floor(totalIn / 12) : 0;
      const inch = Number.isFinite(totalIn) ? (totalIn - ft * 12) : 0;

      const codeW = codeFromWeightLbs(w);
      const h_cm = Number.isFinite(totalIn) ? totalIn * 2.54 : NaN;
      const codeH = Number.isFinite(h_cm) ? codeFromHeightCm(h_cm) : codeW;

      const baseBeforeAdj =
        basis === "weight" ? codeW :
        basis === "height" ? codeH :
        Math.min(codeW, codeH);

      // Age/type adjustment
      let code = baseBeforeAdj;
      if (ageAdj === "auto") {
        if (Number.isFinite(age_years) && (age_years <= 9 || age_years >= 50)) code -= 1;
      } else if (ageAdj === "minus1") {
        code -= 1;
      }
      const type = (skierType || "").toString().toUpperCase();
      if (type === "II") code += 1;
      else if (type === "III") code += 2;

      const baseCode = Math.max(0, Math.min(15, code));
      const bandIdx = bslBandIndex(Number(bsl_mm));
      const dinRaw = DIN_TABLE[baseCode][bandIdx];

      const codeLetter = String.fromCharCode(65 + baseCode);
      const explain = `Base code (W:${String.fromCharCode(65+codeW)} / H:${String.fromCharCode(65+codeH)} → ${String.fromCharCode(65+baseBeforeAdj)}), age adj: ${ageAdj}, type: ${type||"II"}, BSL band ${BSL_BANDS[bandIdx]}.`;

      return { din: dinRaw, code: codeLetter, band: BSL_BANDS[bandIdx], explain };
    }

    // ========= Client store (participant-level) =========
    // key = `${waiver_id}#p${participant_index}` when available, else fall back to name/email composite
    const store = new Map();
    const tb = document.getElementById("tbody");

    function rowKey(r){
      if (r.waiver_id != null && r.participant_index != null) return `${r.waiver_id}#p${r.participant_index}`;
      // fallback if index missing
      return `${r.waiver_id || "?"}#${(r.first_name||"").toLowerCase()}_${(r.last_name||"").toLowerCase()}_${(r.email||"").toLowerCase()}`;
    }

    function upsertToStore(r, meta = {}){
      const key = rowKey(r);
      const prev = store.get(key) || {};
      const merged = {
        ...prev,
        ...r,
        _meta: {
          source: meta.source || prev._meta?.source || "poll",
          createdAt: prev._meta?.createdAt || Date.now(),
          lastSeenInPoll: meta.seenInPoll ? Date.now() : (prev._meta?.lastSeenInPoll || null),
        }
      };
      store.set(key, merged);
    }

    function removeByLiabilityEvent(evt){
      // evt may contain: waiver_id of liability, lightspeed_id, email, participants (array of {first,last,email})
      const lsid = evt?.lightspeed_id || "";
      const email = (evt?.email || "").toLowerCase();
      const names = Array.isArray(evt?.participants) ? evt.participants : null;

      for (const [key, r] of Array.from(store.entries())){
        const matchByTag   = lsid && r.lightspeed_id && String(r.lightspeed_id) === String(lsid);
        const matchByEmail = email && r.email && r.email.toLowerCase() === email;
        let matchByName = false;
        if (names && names.length){
          const fn = (r.first_name||"").toLowerCase(), ln = (r.last_name||"").toLowerCase();
          matchByName = names.some(p => (p.first_name||"").toLowerCase()===fn && (p.last_name||"").toLowerCase()===ln);
        }
        if (matchByTag || matchByEmail || matchByName){
          store.delete(key);
        }
      }
      renderTable();
    }

    function flattenIntakeRows(rows){
      // Accepts:
      //  A) already flattened participant rows
      //  B) waiver-level rows with participants[]: [{ first_name,last_name,age,weight_lb,height_in,skier_type, index }]
      const out = [];
      for (const r of rows){
        if (Array.isArray(r.participants) && r.participants.length){
          r.participants.forEach((p, idx) => {
            out.push({
              waiver_id: r.waiver_id,
              signed_on: r.signed_on,
              intake_pdf_url: r.intake_pdf_url,
              lightspeed_id: r.lightspeed_id || r.ls_id || "",
              email: p.email || r.email || "",
              first_name: p.first_name || "",
              last_name: p.last_name || "",
              age: p.age ?? null,
              weight_lb: p.weight_lb ?? null,
              height_in: p.height_in ?? null,
              skier_type: p.skier_type || "",
              participant_index: p.participant_index != null ? p.participant_index : idx
            });
          });
        } else {
          // assume already participant-level or at least have single participant on row
          out.push({
            waiver_id: r.waiver_id,
            signed_on: r.signed_on,
            intake_pdf_url: r.intake_pdf_url,
            lightspeed_id: r.lightspeed_id || r.ls_id || "",
            email: r.email || "",
            first_name: r.first_name || "",
            last_name: r.last_name || "",
            age: r.age ?? null,
            weight_lb: r.weight_lb ?? null,
            height_in: r.height_in ?? null,
            skier_type: r.skier_type || "",
            participant_index: r.participant_index != null ? r.participant_index : 0
          });
        }
      }
      return out;
    }

    function reconcileFromPoll(rows){
      const flat = flattenIntakeRows(rows);
      flat.forEach(r => upsertToStore(r, { source: "poll", seenInPoll: true }));
    }

    function cleanupStore(){
      const now = Date.now();
      for (const [key, r] of store.entries()){
        // Always keep forever; only remove via liability or if SSE row never confirmed by poll within grace
        const src = r._meta?.source || "poll";
        const seenPoll = r._meta?.lastSeenInPoll || null;
        const createdAt = r._meta?.createdAt || now;
        if (src === "sse" && !seenPoll && (now - createdAt) > SSE_GRACE_MS){
          store.delete(key);
        }
      }
    }

    function renderTable(){
      const rows = Array.from(store.values()).sort((a,b) => {
        const ta = new Date(a.signed_on || a._meta?.createdAt || 0).getTime();
        const tb = new Date(b.signed_on || b._meta?.createdAt || 0).getTime();
        return tb - ta;
      });
      tb.innerHTML = "";
      for (const r of rows){
        const tr = document.createElement("tr");
        tr.className = "border-b";

        const pdfHref = r.waiver_id
          ? `/api/waiver-pdf?waiverId=${encodeURIComponent(r.waiver_id)}`
          : (r.intake_pdf_url || "");

        const pdfCell = pdfHref
          ? `<a class="link" href="${pdfHref}" target="_blank" rel="noopener">Open PDF</a>`
          : "—";

        const statusBadge =
          r._meta?.lastSeenInPoll
            ? `<span class="badge badge-green">synced</span>`
            : (r._meta?.source === "sse"
                ? `<span class="badge badge-amber">pending</span>`
                : `<span class="badge badge-gray">unknown</span>`);

        const hcm = toCmFromInches(r.height_in);

        tr.innerHTML = `
          <td class="py-2 pr-4 whitespace-nowrap">${fmtTime(r.signed_on || r._meta?.createdAt)}</td>
          <td class="py-2 pr-4">${r.first_name || "—"} ${r.last_name || ""}</td>
          <td class="py-2 pr-4">${r.email || "—"}</td>
          <td class="py-2 pr-4">${(r.age ?? "—")}</td>
          <td class="py-2 pr-4">${(r.weight_lb ?? "—")}</td>
          <td class="py-2 pr-4">${hcm || "—"}</td>
          <td class="py-2 pr-4">${r.skier_type || "—"}</td>
          <td class="py-2 pr-4">${r.lightspeed_id || "—"}</td>
          <td class="py-2 pr-4">${pdfCell}</td>
          <td class="py-2 pr-4">${statusBadge}</td>
          <td class="py-2 pr-4">
            <div class="flex items-center gap-2">
              <button
                class="btn-outline"
                data-action="din"
                data-email="${r.email || ""}"
                data-lsid="${r.lightspeed_id || ""}"
                data-first="${r.first_name || ""}"
                data-last="${r.last_name || ""}"
                data-intake="${r.waiver_id || ""}"
                data-pindex="${r.participant_index != null ? r.participant_index : 0}"
              >Compute DIN</button>
              <button
                class="btn"
                data-action="liab"
                data-email="${r.email || ""}"
                data-lsid="${r.lightspeed_id || ""}"
                data-first="${r.first_name || ""}"
                data-last="${r.last_name || ""}"
              >Open Liability</button>
            </div>
          </td>
        `;
        tb.appendChild(tr);

        // Bind row buttons
        tr.querySelectorAll("button").forEach(btn => {
          btn.addEventListener("click", async () => {
            const action = btn.getAttribute("data-action");
            const email  = btn.getAttribute("data-email");
            const lsid   = btn.getAttribute("data-lsid");
            const first  = btn.getAttribute("data-first");
            const last   = btn.getAttribute("data-last");
            const waiverId = btn.getAttribute("data-intake");
            const pindex   = parseInt(btn.getAttribute("data-pindex") || "0", 10);

            if (action === "liab") {
              const url = buildLiabilityUrl({ email, lightspeed_id: lsid, first_name: first, last_name: last });
              window.open(url, "_blank", "noopener");
              return;
            }
            if (action === "din") {
              if (!waiverId) { showToast("No intake ID on row."); return; }
              try {
                const details = await fetchIntakeDetails(waiverId);
                // Expect details.participants[]; fall back to top-level if missing
                let p = null;
                if (Array.isArray(details.participants) && details.participants.length){
                  p = details.participants.find(pp => Number(pp.participant_index) === pindex) || details.participants[pindex] || details.participants[0];
                }
                const participant = p || {
                  first_name: first, last_name: last, email,
                  age: r.age, weight_lb: r.weight_lb, height_in: r.height_in, skier_type: r.skier_type
                };

                const prior = await fetchLatestLiability({ tag: lsid ? `ls_${lsid}` : "", email });

                openDINModalForParticipant({ waiverId, participant, rowMeta: { email, lightspeed_id: lsid, first_name: first, last_name: last } }, prior);
              } catch (e) {
                console.error("intake-details/prior-liability failed:", e);
                showToast("Could not load intake or prior liability.");
              }
            }
          });
        });
      }
      document.getElementById("foot").textContent =
        `Rows: ${rows.length}. SSE grace ${Math.round(SSE_GRACE_MS/1000)}s · Poll ${Math.round(REFRESH_MS/1000)}s.`;
    }

    // ========= DIN modal (participant-specific) =========
    const dinModal = document.getElementById("dinModal");
    const dinClose = document.getElementById("dinClose");
    const outDin = () => document.getElementById("out_din");
    const outSum = () => document.getElementById("out_summary");
    const outLT = () => document.getElementById("out_left_toe");
    const outLH = () => document.getElementById("out_left_heel");
    const outRT = () => document.getElementById("out_right_toe");
    const outRH = () => document.getElementById("out_right_heel");
    const inpBSL = () => document.getElementById("inp_bsl");
    const inpType = () => document.getElementById("inp_type");
    const inpAgeAdj = () => document.getElementById("inp_ageAdj");
    const inpBasis = () => document.getElementById("inp_basis");
    const bslHint = () => document.getElementById("bsl_hint");

    let current = null; // { email, lightspeed_id, first_name, last_name, age, weight_lb, height_in, skier_type }

    function reflectBaseDin(val){
      const s = (val == null || !Number.isFinite(val)) ? "—" : Number(val).toFixed(2);
      outDin().textContent = s;
      outLT().textContent = s;
      outLH().textContent = s;
      outRT().textContent = s;
      outRH().textContent = s;
    }

    function recalc() {
      if (!current) return;
      const res = computeDIN({
        weight_lb: current.weight_lb,
        height_in: current.height_in,
        age_years: current.age,
        skierType: inpType().value,
        bsl_mm: Number(inpBSL().value),
        basis: inpBasis().value,
        ageAdj: inpAgeAdj().value
      });
      reflectBaseDin(res.din);
      outSum().textContent = (res.din == null) ? "" : `Skier code ${res.code}, ${res.explain}`;
    }

    function openDINModalForParticipant({ waiverId, participant, rowMeta }, prior){
      current = {
        email: rowMeta.email || participant.email || "",
        lightspeed_id: rowMeta.lightspeed_id || "",
        first_name: participant.first_name || rowMeta.first_name || "",
        last_name:  participant.last_name || rowMeta.last_name || "",
        age: Number(participant.age) || NaN,
        weight_lb: Number(participant.weight_lb) || NaN,
        height_in: Number(participant.height_in) || NaN,
        skier_type: (participant.skier_type || "").toUpperCase()
      };

      document.getElementById("i_name").textContent = [current.first_name, current.last_name].filter(Boolean).join(" ") || "—";
      document.getElementById("i_email").textContent = current.email || "—";
      document.getElementById("i_age").textContent = Number.isFinite(current.age) ? current.age : "—";
      document.getElementById("i_weight").textContent = Number.isFinite(current.weight_lb) ? `${current.weight_lb} lb` : "—";
      const hcm = Number.isFinite(current.height_in) ? Math.round(current.height_in * 2.54) : null;
      document.getElementById("i_height").textContent = hcm ? `${hcm} cm` : "—";
      document.getElementById("i_skier").textContent = current.skier_type || "—";

      inpBSL().value = "";
      inpType().value = (current.skier_type==="I"||current.skier_type==="II"||current.skier_type==="III") ? current.skier_type : "II";
      inpAgeAdj().value = "auto";
      inpBasis().value = "weight";
      bslHint().textContent = "";

      if (prior && prior.bsl_mm) {
        inpBSL().value = prior.bsl_mm;
        bslHint().textContent = `Found previous BSL ${prior.bsl_mm} mm from ${prior.signed_on ? new Date(prior.signed_on).toLocaleString() : "past liability"}.`;
      }

      reflectBaseDin(null);
      outSum().textContent = "";

      dinModal.classList.remove("hidden");
      dinModal.classList.add("flex");

      recalc();
    }

    document.getElementById("btnCopy").addEventListener("click", async () => {
      const s = outDin().textContent;
      const txt = `DIN ${s} — L Toe ${outLT().textContent}, L Heel ${outLH().textContent}, R Toe ${outRT().textContent}, R Heel ${outRH().textContent}. ${outSum().textContent}`;
      try { await navigator.clipboard.writeText(txt); showToast("DIN set copied"); } catch { showToast("Copy failed"); }
    });
    document.getElementById("btnOpenLiab").addEventListener("click", () => {
      if (!current) return;
      const url = buildLiabilityUrl({
        email: current.email,
        lightspeed_id: current.lightspeed_id,
        first_name: current.first_name,
        last_name:  current.last_name
      });
      window.open(url, "_blank", "noopener");
    });
    document.getElementById("dinClose").addEventListener("click", () => {
      dinModal.classList.add("hidden");
      dinModal.classList.remove("flex");
      current = null;
    });
    [ "change", "keyup", "input" ].forEach(evt => {
      document.getElementById("inp_bsl").addEventListener(evt, recalc);
      document.getElementById("inp_type").addEventListener(evt, recalc);
      document.getElementById("inp_ageAdj").addEventListener(evt, recalc);
      document.getElementById("inp_basis").addEventListener(evt, recalc);
    });

    // ========= Fetch / Render / Cleanup =========
    async function refresh() {
      try {
        // Prefer the "all time, open only" endpoint; fallback to today-intakes
        let r = await fetch("/api/open-intakes?since=all");
        if (r.status === 404) r = await fetch("/api/today-intakes"); // backward compatible
        const data = await r.json();

        const rows = Array.isArray(data?.rows) ? data.rows : [];
        reconcileFromPoll(rows);
        cleanupStore();
        renderTable();
      } catch (e) {
        console.error(e);
        showToast("Failed to refresh list");
      }
    }
    document.getElementById("refreshBtn").addEventListener("click", refresh);

    // Periodic cleanup
    setInterval(() => { cleanupStore(); renderTable(); }, CLEANUP_MS);

    // Auto-refresh with visibility pause/resume
    let refreshTimer = null;
    function startAutoRefresh(){
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(refresh, REFRESH_MS);
    }
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) { if (refreshTimer) clearInterval(refreshTimer); }
      else { refresh(); startAutoRefresh(); }
    });

    // ========= SSE (intake add + liability remove) =========
    function upsertRowFromIntakeWebhook(evt) {
      // evt should contain waiver_id, signed_on, intake_pdf_url, lightspeed_id, participants[]
      // Flatten participants → store
      const rows = flattenIntakeRows([evt]);
      rows.forEach(r => upsertToStore(r, { source: "sse" }));
      renderTable();
    }
    function handleLiabilityWebhook(evt) {
      // evt: { lightspeed_id?, email?, participants?:[{first_name,last_name,email?}], waiver_id? }
      removeByLiabilityEvent(evt);
    }
    function startSSE(){
      try {
        const es = new EventSource("/api/stream");
        es.addEventListener("intake",   (ev) => { try { upsertRowFromIntakeWebhook(JSON.parse(ev.data)); } catch {} });
        es.addEventListener("liability",(ev) => { try { handleLiabilityWebhook(JSON.parse(ev.data)); } catch {} });
        es.addEventListener("ping",     () => {});
        es.onerror = () => { /* browser auto-reconnects */ };
      } catch (e) {
        console.warn("SSE unavailable", e);
      }
    }

    // ========= Boot =========
    (async () => {
      try {
        const r = await fetch("/api/config");
        const cfg = await r.json();
        LIABILITY_WAIVER_ID = cfg.liability_waiver_id || "";
      } catch (e) {
        console.error("config fetch failed:", e);
        showToast("Failed to load config");
      }
      await refresh();    // seed store
      startSSE();         // instant intake adds + liability removals
      startAutoRefresh(); // poll as safety net
    })();
  </script>
</body>
</html>
