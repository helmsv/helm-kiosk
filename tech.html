<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Helm — Tech Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    tr:hover { background: #f9fafb; }
    .btn { @apply rounded-xl bg-black text-white px-3 py-2 text-sm font-semibold hover:opacity-90; }
    .btn-outline { @apply rounded-xl border border-gray-300 px-3 py-2 text-sm font-semibold hover:bg-gray-50; }
    .link { @apply text-blue-600 hover:underline; }
    .kbd { @apply inline-block rounded-md border border-gray-300 px-1.5 py-0.5 text-xs bg-gray-50; }
    .input { @apply w-full rounded-xl border border-gray-300 p-2.5 focus:outline-none focus:ring-2 focus:ring-black; }
    .select { @apply w-full rounded-xl border border-gray-300 p-2.5 focus:outline-none focus:ring-2 focus:ring-black; appearance: none; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <main class="mx-auto max-w-6xl p-6 pt-10">
    <div class="bg-white shadow-xl rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">Customers Needing Liability (Last 24h)</h1>
        <div class="flex items-center gap-3">
          <button id="refreshBtn" class="btn">Refresh</button>
        </div>
      </div>
      <p class="text-sm text-gray-600 mb-4">
        Shows Intakes in the last 24 hours that have no Liability yet (matched by Smartwaiver tag <code>ls_&lt;lightspeed_id&gt;</code> or, if missing, by email).
      </p>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-600 border-b">
              <th class="py-2 pr-4">Signed</th>
              <th class="py-2 pr-4">Email</th>
              <th class="py-2 pr-4">First</th>
              <th class="py-2 pr-4">Last</th>
              <th class="py-2 pr-4">LS ID</th>
              <th class="py-2 pr-4">Intake PDF</th>
              <th class="py-2 pr-4">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="foot" class="text-xs text-gray-500 mt-3"></div>
      <div class="text-xs text-gray-400 mt-1">build: tech-din-preliab-v2</div>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden rounded-xl bg-black text-white px-4 py-2 text-sm shadow-lg"></div>

  <!-- DIN modal -->
  <div id="dinModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-[800px] max-w-[95vw]">
      <div class="flex items-start justify-between mb-3">
        <h3 class="text-lg font-semibold">DIN Calculator (pre-Liability)</h3>
        <button id="dinClose" class="btn-outline">Close</button>
      </div>

      <div id="dinBody" class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <!-- Left: Intake snapshot -->
        <div class="border rounded-xl p-4">
          <h4 class="font-semibold mb-2">Intake Measurements</h4>
          <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
            <dt class="text-gray-500">Name</dt><dd id="i_name" class="font-medium">—</dd>
            <dt class="text-gray-500">Email</dt><dd id="i_email" class="font-medium">—</dd>
            <dt class="text-gray-500">Age</dt><dd id="i_age" class="font-medium">—</dd>
            <dt class="text-gray-500">Weight</dt><dd id="i_weight" class="font-medium">—</dd>
            <dt class="text-gray-500">Height</dt><dd id="i_height" class="font-medium">—</dd>
            <dt class="text-gray-500">Skier Type</dt><dd id="i_skier" class="font-medium">—</dd>
          </dl>
          <p class="text-xs text-gray-500 mt-3">Height is shown in centimeters for clarity. Intake source: Smartwaiver.</p>
        </div>

        <!-- Right: Inputs & Result -->
        <div class="border rounded-xl p-4">
          <h4 class="font-semibold mb-2">Tech Inputs</h4>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs text-gray-600 mb-1">Boot Sole Length (mm)</label>
              <input id="inp_bsl" type="number" min="200" max="420" step="1" class="input" placeholder="e.g. 305">
            </div>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Skier Type</label>
              <select id="inp_type" class="select">
                <option value="I">Type I (conservative)</option>
                <option value="II">Type II (average)</option>
                <option value="III">Type III (aggressive)</option>
              </select>
              <p class="text-[11px] text-gray-500 mt-1">Prefilled from Intake when available.</p>
            </div>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Age Adjustment</label>
              <select id="inp_ageAdj" class="select">
                <option value="auto" selected>Auto (use intake age)</option>
                <option value="none">No adjustment</option>
                <option value="minus1">Reduce one level</option>
              </select>
              <p class="text-[11px] text-gray-500 mt-1">Under ~10 or over ~49 typically reduce one level (ISO guidance).</p>
            </div>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Basis (Weight vs Height)</label>
              <select id="inp_basis" class="select">
                <option value="auto" selected>Auto (more conservative)</option>
                <option value="weight">Weight only</option>
                <option value="height">Height only</option>
              </select>
            </div>
          </div>

          <div class="mt-4 border rounded-lg p-3 bg-gray-50">
            <div class="text-sm text-gray-600">Result</div>
            <div class="mt-1 flex items-baseline gap-3">
              <div class="text-2xl font-bold" id="out_din">—</div>
              <div class="text-sm text-gray-500">Release value</div>
            </div>
            <div class="mt-1 text-xs text-gray-600" id="out_summary"></div>
          </div>

          <div class="mt-4 flex items-center gap-3">
            <button id="btnCopy" class="btn-outline">Copy DIN <span class="kbd">⌘C</span></button>
            <button id="btnOpenLiab" class="btn">Open Liability</button>
          </div>

          <p class="text-[11px] text-gray-500 mt-3 leading-relaxed">
            <strong>Disclaimer:</strong> Quick-reference DIN suggestion derived from an ISO-style chart.
            Always cross-check with current ISO 11088/manufacturer charts & shop procedures.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Runtime config =====
    let LIABILITY_WAIVER_ID = "";
    const REFRESH_MS = 30000; // 30s

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 2500);
    }
    function fmtTime(s) { try { return new Date(s).toLocaleString(); } catch { return s || "—"; } }

    async function fetchIntakeDetails(waiverId) {
      const r = await fetch(`/api/intake-details?waiverId=${encodeURIComponent(waiverId)}`);
      if (!r.ok) throw new Error(`intake-details ${r.status}`);
      return await r.json();
    }

    function buildLiabilityUrl({ email, lightspeed_id, first_name, last_name }) {
      const p = new URLSearchParams();
      if (email) p.set("wautofill_email", email);
      if (lightspeed_id) p.set("wautofill_tag", `ls_${lightspeed_id}`);
      if (first_name) p.set("wautofill_firstname", first_name);
      if (last_name)  p.set("wautofill_lastname",  last_name);
      return `https://www.smartwaiver.com/w/${LIABILITY_WAIVER_ID}/kiosk/?${p.toString()}`;
    }

    // ===== DIN calc tables (same as v1) =====
    const CODE_BY_WEIGHT = [
      { max:  48, code: 0 }, { max:  57, code: 1 }, { max:  66, code: 2 }, { max:  78, code: 3 },
      { max:  91, code: 4 }, { max: 109, code: 5 }, { max: 126, code: 6 }, { max: 147, code: 7 },
      { max: 169, code: 8 }, { max: 191, code: 9 }, { max: 213, code:10 }, { max: 235, code:11 },
      { max: 257, code:12 }, { max: 279, code:13 }, { max: 301, code:14 }, { max: 1000, code:15 },
    ];
    const CODE_BY_HEIGHT_CM = [
      { max: 148, code: 0 }, { max: 157, code: 1 }, { max: 166, code: 2 },
      { max: 176, code: 3 }, { max: 186, code: 4 }, { max: 196, code: 5 }, { max: 999, code: 6 },
    ];
    const DIN_TABLE = [
      [0.75, 0.75, 0.75, 0.75, 1.00, 1.00],
      [0.75, 0.75, 1.00, 1.00, 1.50, 1.50],
      [0.75, 1.00, 1.50, 1.50, 2.00, 2.00],
      [1.00, 1.50, 2.00, 2.25, 2.50, 3.00],
      [1.50, 2.00, 2.50, 3.00, 3.50, 3.50],
      [2.00, 2.50, 3.00, 3.50, 4.00, 4.50],
      [2.50, 3.00, 3.50, 4.00, 4.50, 5.00],
      [3.00, 3.50, 4.50, 5.00, 5.50, 6.00],
      [3.50, 4.50, 5.50, 6.00, 6.50, 7.00],
      [4.00, 5.50, 6.50, 7.50, 8.00, 8.50],
      [4.50, 6.00, 7.50, 8.50, 9.50, 10.0],
      [5.50, 7.00, 8.50, 9.50, 10.5, 11.5],
      [6.50, 8.00,10.0, 11.0, 12.0, 13.5],
      [7.50, 9.50,11.0, 12.5, 14.0, 15.5],
      [8.50,11.0, 12.5, 14.0, 16.0, 17.5],
      [10.0,12.0, 14.0, 16.0, 18.0, 20.0],
    ];
    function bslBandIndex(bsl) {
      if (bsl >= 231 && bsl <= 250) return 0;
      if (bsl >= 251 && bsl <= 270) return 1;
      if (bsl >= 271 && bsl <= 290) return 2;
      if (bsl >= 291 && bsl <= 310) return 3;
      if (bsl >= 311 && bsl <= 330) return 4;
      if (bsl >= 331 && bsl <= 350) return 5;
      if (bsl < 231) return 0; return 5;
    }
    function codeFromWeightLbs(w) { for (const r of CODE_BY_WEIGHT) if (w <= r.max) return r.code; return 0; }
    function codeFromHeightCm(cm) { for (const r of CODE_BY_HEIGHT_CM) if (cm <= r.max) return r.code; return 0; }
    function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n)); }
    function computeDIN({ weight_lb, height_in, age_years, skierType, bsl_mm, basis = "auto", ageAdj = "auto" }) {
      const h_cm = height_in ? (Number(height_in) * 2.54) : NaN;
      const w_lb = Number(weight_lb);
      if (!Number.isFinite(w_lb)) return { din: "", code: "", band: "", explain: "Missing weight" };
      const codeW = codeFromWeightLbs(w_lb);
      const codeH = Number.isFinite(h_cm) ? codeFromHeightCm(h_cm) : codeW;
      let baseCode;
      if (basis === "weight") baseCode = codeW;
      else if (basis === "height") baseCode = codeH;
      else baseCode = Math.min(codeW, codeH);

      let code = baseCode;
      if (ageAdj === "auto") {
        if (Number.isFinite(age_years) && (age_years <= 10 || age_years >= 50)) code -= 1;
      } else if (ageAdj === "minus1") code -= 1;

      if (skierType === "I") code -= 1;
      if (skierType === "III") code += 1;

      code = clamp(code, 0, DIN_TABLE.length - 1);
      const band = bslBandIndex(Number(bsl_mm));
      const din = DIN_TABLE[code][band];
      const codeLetter = String.fromCharCode(65 + code);
      const bands = ["231–250","251–270","271–290","291–310","311–330","331–350"];
      const explain =
        `Base code (W:${String.fromCharCode(65+codeW)} / H:${String.fromCharCode(65+codeH)} → ${String.fromCharCode(65+baseCode)}), `
        + `age adj: ${ageAdj}, type: ${skierType || "II"}, BSL band ${bands[band]}.`;
      return { din: din?.toFixed(1), code: codeLetter, band: bands[band], explain };
    }

    // ===== UI wiring =====
    const tb = document.getElementById("tbody");
    const dinModal = document.getElementById("dinModal");
    const dinClose = document.getElementById("dinClose");
    const outDin = () => document.getElementById("out_din");
    const outSum = () => document.getElementById("out_summary");
    const inpBSL = () => document.getElementById("inp_bsl");
    const inpType = () => document.getElementById("inp_type");
    const inpAgeAdj = () => document.getElementById("inp_ageAdj");
    const inpBasis = () => document.getElementById("inp_basis");

    let currentRow = null;

    function openDINModal(intake, row) {
      currentRow = {
        email: row.email || "",
        lightspeed_id: row.lightspeed_id || "",
        first_name: row.first_name || intake.first_name || "",
        last_name: row.last_name || intake.last_name || "",
        waiver_id: row.waiver_id || "",
        age: Number(intake.age) || NaN,
        weight_lb: Number(intake.weight_lb) || NaN,
        height_in: Number(intake.height_in) || NaN,
        skier_type: (intake.skier_type || "").toUpperCase() // "I" | "II" | "III" | ""
      };

      // Fill Intake snapshot (height in cm)
      document.getElementById("i_name").textContent = [currentRow.first_name, currentRow.last_name].filter(Boolean).join(" ") || "—";
      document.getElementById("i_email").textContent = currentRow.email || "—";
      document.getElementById("i_age").textContent = Number.isFinite(currentRow.age) ? currentRow.age : "—";
      document.getElementById("i_weight").textContent = Number.isFinite(currentRow.weight_lb) ? `${currentRow.weight_lb} lb` : "—";
      const hcm = Number.isFinite(currentRow.height_in) ? Math.round(currentRow.height_in * 2.54) : null;
      document.getElementById("i_height").textContent = hcm ? `${hcm} cm` : "—";
      document.getElementById("i_skier").textContent = currentRow.skier_type || "—";

      // Defaults: prefer Intake skier type if available
      inpBSL().value = "";
      inpType().value = (currentRow.skier_type === "I" || currentRow.skier_type === "II" || currentRow.skier_type === "III")
        ? currentRow.skier_type : "II";
      inpAgeAdj().value = "auto";
      inpBasis().value = "auto";

      outDin().textContent = "—";
      outSum().textContent = "";

      dinModal.classList.remove("hidden");
      dinModal.classList.add("flex");
    }

    function recalc() {
      if (!currentRow) return;
      const res = computeDIN({
        weight_lb: currentRow.weight_lb,
        height_in: currentRow.height_in,
        age_years: currentRow.age,
        skierType: inpType().value,
        bsl_mm: Number(inpBSL().value),
        basis: inpBasis().value,
        ageAdj: inpAgeAdj().value
      });
      outDin().textContent = res.din || "—";
      outSum().textContent = res.din ? `Skier code ${res.code}, ${res.explain}` : "";
    }

    document.getElementById("btnCopy").addEventListener("click", async () => {
      const txt = `DIN: ${outDin().textContent} (${outSum().textContent})`;
      try { await navigator.clipboard.writeText(txt); showToast("DIN copied"); } catch { showToast("Copy failed"); }
    });

    document.getElementById("btnOpenLiab").addEventListener("click", () => {
      if (!currentRow) return;
      const url = buildLiabilityUrl({
        email: currentRow.email,
        lightspeed_id: currentRow.lightspeed_id,
        first_name: currentRow.first_name,
        last_name:  currentRow.last_name
      });
      window.open(url, "_blank", "noopener");
    });

    [ "change", "keyup", "input" ].forEach(evt => {
      inpBSL().addEventListener(evt, recalc);
      inpType().addEventListener(evt, recalc);
      inpAgeAdj().addEventListener(evt, recalc);
      inpBasis().addEventListener(evt, recalc);
    });

    dinClose.addEventListener("click", () => {
      dinModal.classList.add("hidden");
      dinModal.classList.remove("flex");
      currentRow = null;
    });

    function renderRows(rows) {
      const tb = document.getElementById("tbody");
      tb.innerHTML = "";
      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.className = "border-b";
        const pdfCell = r.intake_pdf_url
          ? `<a class="link" href="${r.intake_pdf_url}" target="_blank" rel="noopener">Open PDF</a>`
          : "—";
        tr.innerHTML = `
          <td class="py-2 pr-4 whitespace-nowrap">${fmtTime(r.signed_on)}</td>
          <td class="py-2 pr-4">${r.email || "—"}</td>
          <td class="py-2 pr-4">${r.first_name || "—"}</td>
          <td class="py-2 pr-4">${r.last_name || "—"}</td>
          <td class="py-2 pr-4">${r.lightspeed_id || "—"}</td>
          <td class="py-2 pr-4">${pdfCell}</td>
          <td class="py-2 pr-4">
            <div class="flex items-center gap-2">
              <button
                class="btn-outline"
                data-action="din"
                data-email="${r.email || ""}"
                data-lsid="${r.lightspeed_id || ""}"
                data-first="${r.first_name || ""}"
                data-last="${r.last_name || ""}"
                data-intake="${r.waiver_id || ""}"
              >Compute DIN</button>
              <button
                class="btn"
                data-action="liab"
                data-email="${r.email || ""}"
                data-lsid="${r.lightspeed_id || ""}"
                data-first="${r.first_name || ""}"
                data-last="${r.last_name || ""}"
              >Open Liability</button>
            </div>
          </td>
        `;
        tb.appendChild(tr);
      }

      tb.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", async () => {
          const action = btn.getAttribute("data-action");
          const email  = btn.getAttribute("data-email");
          const lsid   = btn.getAttribute("data-lsid");
          const first  = btn.getAttribute("data-first");
          const last   = btn.getAttribute("data-last");
          const intakeWaiverId = btn.getAttribute("data-intake");

          if (action === "liab") {
            const url = buildLiabilityUrl({ email, lightspeed_id: lsid, first_name: first, last_name: last });
            window.open(url, "_blank", "noopener");
            return;
          }

          if (action === "din") {
            if (!intakeWaiverId) { showToast("No intake ID on row."); return; }
            try {
              const details = await fetchIntakeDetails(intakeWaiverId);
              details.waiver_id = intakeWaiverId;
              openDINModal(details, { email, lightspeed_id: lsid, first_name: first, last_name: last, waiver_id: intakeWaiverId });
              recalc();
            } catch (e) {
              console.error("intake-details failed:", e);
              showToast("Could not load intake measurements.");
            }
          }
        });
      });
    }

    async function refresh() {
      try {
        const r = await fetch("/api/today-intakes");
        const data = await r.json();
        renderRows(data.rows || []);
        document.getElementById("foot").textContent =
          `Window: ${data.from || "?"} → ${data.to || "?"}. Auto-refresh every ${Math.floor(REFRESH_MS/1000)}s.`;
      } catch (e) {
        console.error(e);
        showToast("Failed to refresh list");
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", refresh);

    (async () => {
      try {
        const r = await fetch("/api/config");
        const cfg = await r.json();
        LIABILITY_WAIVER_ID = cfg.liability_waiver_id || "";
      } catch (e) {
        console.error("config fetch failed:", e);
        showToast("Failed to load config");
      }
      await refresh();
      setInterval(refresh, REFRESH_MS);
    })();
  </script>
</body>
</html>