<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Helm — Tech Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    tr:hover { background: #f9fafb; }
    .btn { @apply rounded-xl bg-black text-white px-3 py-2 text-sm font-semibold hover:opacity-90; }
    .link { @apply text-blue-600 hover:underline; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <main class="mx-auto max-w-5xl p-6 pt-10">
    <div class="bg-white shadow-xl rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">Customers Needing Liability (Last 24h)</h1>
        <div class="flex items-center gap-3">
          <button id="refreshBtn" class="btn">Refresh</button>
        </div>
      </div>
      <p class="text-sm text-gray-600 mb-4">
        Shows Intakes in the last 24 hours that have no Liability yet (matched by Smartwaiver tag <code>ls_&lt;lightspeed_id&gt;</code> or, if missing, by email).
      </p>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-600 border-b">
              <th class="py-2 pr-4">Signed</th>
              <th class="py-2 pr-4">Email</th>
              <th class="py-2 pr-4">First</th>
              <th class="py-2 pr-4">Last</th>
              <th class="py-2 pr-4">LS ID</th>
              <th class="py-2 pr-4">Intake PDF</th>
              <th class="py-2 pr-4">Action</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="foot" class="text-xs text-gray-500 mt-3"></div>
      <div class="text-xs text-gray-400 mt-1">build: tech-overlay-v3</div>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden rounded-xl bg-black text-white px-4 py-2 text-sm shadow-lg"></div>

  <script>
    let LIABILITY_WAIVER_ID = "";
    const REFRESH_MS = 30000; // 30s

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 3000);
    }

    function fmtTime(s) {
      try { return new Date(s).toLocaleString(); } catch { return s || "—"; }
    }

    function buildLiabilityUrl({ email, lightspeed_id, first_name, last_name }) {
      const p = new URLSearchParams();
      if (email) p.set("wautofill_email", email);
      if (lightspeed_id) p.set("wautofill_tag", `ls_${lightspeed_id}`);
      if (first_name) p.set("wautofill_firstname", first_name);
      if (last_name)  p.set("wautofill_lastname",  last_name);
      return `https://www.smartwaiver.com/w/${LIABILITY_WAIVER_ID}/kiosk/?${p.toString()}`;
    }

    async function fetchIntakeDetails(waiverId) {
      const r = await fetch(`/api/intake-details?waiverId=${encodeURIComponent(waiverId)}`);
      if (!r.ok) throw new Error(`intake-details ${r.status}`);
      return await r.json();
    }

    function showOverlay(details) {
      document.getElementById("overlay-intake")?.remove();
      const missing = (!details.age || !details.weight_lb || !details.height_in);
      const dbg = details.waiver_id
        ? `<a class="text-xs text-blue-600 hover:underline" target="_blank" rel="noopener"
             href="/api/intake-details?waiverId=${encodeURIComponent(details.waiver_id)}&debug=1">Debug raw</a>`
        : "";

      const div = document.createElement("div");
      div.id = "overlay-intake";
      div.className = "fixed inset-0 bg-black/50 flex items-center justify-center z-50";
      div.innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl p-6 w-[420px]">
          <h3 class="text-lg font-semibold mb-3">Intake Measurements</h3>
          <div class="space-y-1 text-sm">
            <div><strong>Name:</strong> ${[details.first_name, details.last_name].filter(Boolean).join(" ") || "—"}</div>
            <div><strong>Email:</strong> ${details.email || "—"}</div>
            <div><strong>Age:</strong> ${details.age || "—"}</div>
            <div><strong>Weight (lb):</strong> ${details.weight_lb || "—"}</div>
            <div><strong>Height (in):</strong> ${details.height_in || "—"}</div>
          </div>
          <div class="mt-4 flex items-center justify-between">
            <div class="text-gray-500">${missing ? dbg : ""}</div>
            <button id="overlayClose" class="rounded-xl bg-black text-white px-3 py-2 text-sm font-semibold hover:opacity-90">Close</button>
          </div>
        </div>`;
      document.body.appendChild(div);
      document.getElementById("overlayClose").onclick = () => div.remove();
    }

    function renderRows(rows) {
      const tb = document.getElementById("tbody");
      tb.innerHTML = "";
      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.className = "border-b";
        const pdfCell = r.intake_pdf_url
          ? `<a class="link" href="${r.intake_pdf_url}" target="_blank" rel="noopener">Open PDF</a>`
          : "—";
        tr.innerHTML = `
          <td class="py-2 pr-4 whitespace-nowrap">${fmtTime(r.signed_on)}</td>
          <td class="py-2 pr-4">${r.email || "—"}</td>
          <td class="py-2 pr-4">${r.first_name || "—"}</td>
          <td class="py-2 pr-4">${r.last_name || "—"}</td>
          <td class="py-2 pr-4">${r.lightspeed_id || "—"}</td>
          <td class="py-2 pr-4">${pdfCell}</td>
          <td class="py-2 pr-4">
            <button
              class="btn"
              data-email="${r.email || ""}"
              data-lsid="${r.lightspeed_id || ""}"
              data-first="${r.first_name || ""}"
              data-last="${r.last_name || ""}"
              data-intake="${r.waiver_id || ""}"
            >Open Liability</button>
          </td>
        `;
        tb.appendChild(tr);
      }

      tb.querySelectorAll("button[data-email]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const email = btn.getAttribute("data-email");
          const lsid  = btn.getAttribute("data-lsid");
          const first = btn.getAttribute("data-first");
          const last  = btn.getAttribute("data-last");
          const intakeWaiverId = btn.getAttribute("data-intake");

          if (intakeWaiverId) {
            try {
              const details = await fetchIntakeDetails(intakeWaiverId);
              details.waiver_id = intakeWaiverId; // for Debug link
              showOverlay(details);
            } catch (e) {
              console.error("intake-details failed:", e);
              showToast("Could not load intake measurements.");
            }
          } else {
            showToast("No intake ID on row.");
          }

          const url = buildLiabilityUrl({
            email,
            lightspeed_id: lsid,
            first_name: first,
            last_name:  last
          });
          window.open(url, "_blank", "noopener");
        });
      });
    }

    async function refresh() {
      try {
        const r = await fetch("/api/today-intakes");
        const data = await r.json();
        renderRows(data.rows || []);
        document.getElementById("foot").textContent =
          `Window: ${data.from || "?"} → ${data.to || "?"}. Auto-refresh every ${Math.floor(REFRESH_MS/1000)}s.`;
      } catch (e) {
        console.error(e);
        showToast("Failed to refresh list");
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", refresh);

    (async () => {
      try {
        const r = await fetch("/api/config");
        const cfg = await r.json();
        LIABILITY_WAIVER_ID = cfg.liability_waiver_id || "";
      } catch (e) {
        console.error("config fetch failed:", e);
        showToast("Failed to load config");
      }
      await refresh();
      setInterval(refresh, REFRESH_MS);
    })();
  </script>
</body>
</html>